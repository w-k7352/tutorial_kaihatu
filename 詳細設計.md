# 詳細設計書 v1.0 — 1画面「ToDo＋期限管理」ミニWebアプリ

## 1. 設計概要

本ドキュメントは「基本設計書 v1.0」に基づき、各モジュールの詳細な仕様、関数シグネチャ、データフロー、および具体的な処理ロジックを定義する。これにより、実装作業の指針とする。

## 2. ファイル構成

```
/
├── index.html
├── style.css
├── app.js         # メインロジック、イベントハンドリング
├── view.js        # DOM操作、描画処理
├── storage.js     # localStorageとのデータ送受信
└── utils.js       # 共通関数
```

## 3. `index.html` 詳細設計

主要な要素にIDを付与し、JavaScriptからのアクセスを容易にする。

```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDo App</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header>
        <h1>ToDo App</h1>
        <div id="task-counters">
            <span>未着手: <span id="counter-todo">0</span></span>
            <span>進行中: <span id="counter-doing">0</span></span>
            <span>完了: <span id="counter-done">0</span></span>
        </div>
    </header>

    <main>
        <section id="add-task-section">
            <form id="add-task-form">
                <input type="text" id="form-title" placeholder="タスクのタイトル" required aria-label="新しいタスクのタイトル">
                <input type="date" id="form-due" aria-label="期限">
                <input type="text" id="form-tags" placeholder="タグ (カンマ区切り)" aria-label="タグ">
                <button type="submit">追加</button>
            </form>
        </section>

        <section id="filter-sort-section">
            <input type="text" id="filter-keyword" placeholder="キーワードで検索">
            <select id="filter-status">
                <option value="all">すべてのステータス</option>
                <option value="todo">未着手</option>
                <option value="doing">進行中</option>
                <option value="done">完了</option>
            </select>
            <select id="sort-by">
                <option value="created_at_desc">作成日(新しい順)</option>
                <option value="created_at_asc">作成日(古い順)</option>
                <option value="due_asc">期限(昇順)</option>
                <option value="title_asc">タイトル(昇順)</option>
            </select>
            <button id="clear-filters-btn">フィルタをクリア</button>
        </section>

        <section id="task-list-section">
            <table id="task-table">
                <thead>
                    <tr>
                        <th>完了</th>
                        <th>タイトル</th>
                        <th>期限</th>
                        <th>タグ</th>
                        <th>ステータス</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="task-list-body"></tbody>
            </table>
        </section>
    </main>

    <footer>
        <button id="export-csv-btn">CSVエクスポート</button>
    </footer>

    <script src="utils.js"></script>
    <script src="storage.js"></script>
    <script src="view.js"></script>
    <script src="app.js"></script>
</body>
</html>
```

## 4. `style.css` 詳細設計

- **命名規則**: BEM（Block__Element--Modifier）を簡易的に採用する。
    - 例: `task-item`, `task-item__title`, `task-item--completed`
- **状態クラス**:
    - `.task-item--completed .task-item__title`: タイトルに打消し線を適用。
    - `.due-badge--overdue`: 期限切れバッジ（赤系）。
    - `.due-badge--today`: 本日期限バッジ（青系強調）。
    - `.due-badge--future`: 未来期限バッジ（緑系）。
- **レスポンシブ**: メディアクエリ (`@media (max-width: 768px)`) を使用し、テーブル表示をカード形式に切り替えるなど、モバイル表示に最適化する。

## 5. `storage.js` (リポジトリ層) 詳細設計

`localStorage`とのやり取りを完全にカプセル化する。

```javascript
// storage.js

const STORAGE_KEY = 'todo_tasks_v1';

/**
 * localStorageから全てのタスクを取得する
 * @returns {Array<Object>} Taskオブジェクトの配列
 */
function fetchAllTasks() {
    const tasksJson = localStorage.getItem(STORAGE_KEY);
    return tasksJson ? JSON.parse(tasksJson) : [];
}

/**
 * 全てのタスクをlocalStorageに保存する
 * @param {Array<Object>} tasks - 保存するTaskオブジェクトの配列
 */
function saveAllTasks(tasks) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
}
```

## 6. `utils.js` (共通関数) 詳細設計

汎用的なヘルパー関数を定義する。

```javascript
// utils.js

/**
 * UUID v4を生成する
 * @returns {string} 一意なID
 */
function generateUUID() {
    return crypto.randomUUID();
}

/**
 * ISO 8601形式の現在時刻を取得する
 * @returns {string}
 */
function getCurrentISOTime() {
    return new Date().toISOString();
}

/**
 * タスク配列をCSV文字列に変換する
 * @param {Array<Object>} tasks
 * @returns {string} CSV形式の文字列
 */
function generateCSV(tasks) {
    const header = 'id,title,due,tags,status,created_at,updated_at';
    const rows = tasks.map(task => {
        const tags = task.tags.join(',');
        return `${task.id},"${task.title}",${task.due || ''},"${tags}",${task.status},${task.created_at},${task.updated_at}`;
    });
    return [header, ...rows].join('\n');
}

/**
 * CSVダウンロードをトリガーする
 * @param {string} csvContent
 * @param {string} fileName
 */
function triggerCsvDownload(csvContent, fileName) {
    const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
    const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(url);
}
```

## 7. `view.js` (UI/DOM操作) 詳細設計

DOMの読み書きと描画更新に特化する。

```javascript
// view.js

const dom = { /* DOM要素への参照を保持 */ };

/**
 * DOM要素の参照を初期化する
 */
function initializeDOM() { /* ... */ }

/**
 * タスク一覧を描画する
 * @param {Array<Object>} tasks - 描画するタスクの配列
 */
function renderTasks(tasks) {
    // tbodyの中身をクリア
    // tasks.forEach(task => { ... create task row ... });
}

/**
 * 1つのタスク行(tr)を生成する
 * @param {Object} task
 * @returns {HTMLElement} tr要素
 */
function createTaskRowElement(task) {
    // tr, td要素を生成
    // 期限バッジのロジック (getDueBadgeClass)
    // ステータスバッジのロジック
    // 完了チェックボックス、編集・削除ボタンを生成
    // data-id属性にタスクIDを設定
}

/**
 * タスクカウンターを更新する
 * @param {Array<Object>} tasks - 全てのタスク
 */
function renderCounters(tasks) {
    // tasks.reduce(...) で各ステータスの件数を計算
    // dom.counterTodo.textContent = ...
}

/**
 * 新規登録フォームをクリアする
 */
function clearForm() { /* ... */ }

/**
 * フォームから値を取得する
 * @returns {{title: string, due: string, tags: string[]}}
 */
function getFormValues() { /* ... */ }
```

## 8. `app.js` (メインロジック) 詳細設計

アプリケーションの状態管理とイベントハンドリングを担う。

```javascript
// app.js

// --- 状態管理 ---
let allTasks = [];
let filterAndSortState = {
    keyword: '',
    status: 'all',
    sortBy: 'created_at_desc'
};

// --- 初期化 ---
document.addEventListener('DOMContentLoaded', initializeApp);

function initializeApp() {
    view.initializeDOM();
    setupEventListeners();
    allTasks = storage.fetchAllTasks();
    refreshView();
}

// --- イベントリスナー設定 ---
function setupEventListeners() {
    // 新規タスク追加フォームのsubmitイベント
    // フィルタ・ソートのchangeイベント
    // タスク一覧のクリック（イベントデリゲーション）
    // CSVエクスポートボタンのclickイベント
}

// --- イベントハンドラ ---
function handleAddTask(event) {
    event.preventDefault();
    const { title, due, tags } = view.getFormValues();
    if (!title) { /* alert or message */ return; }

    const newTask = { /* ... Taskオブジェクト生成 ... */ };
    allTasks.push(newTask);
    storage.saveAllTasks(allTasks);
    refreshView();
    view.clearForm();
}

function handleTaskAction(event) {
    const target = event.target;
    const taskId = target.closest('.task-item').dataset.id;

    if (target.matches('.delete-btn')) {
        if (confirm('本当に削除しますか？')) {
            allTasks = allTasks.filter(t => t.id !== taskId);
            storage.saveAllTasks(allTasks);
            refreshView();
        }
    } else if (target.matches('.status-toggle')) {
        const task = allTasks.find(t => t.id === taskId);
        task.status = (task.status === 'done') ? 'todo' : 'done';
        task.updated_at = utils.getCurrentISOTime();
        storage.saveAllTasks(allTasks);
        refreshView();
    }
    // ... 編集処理も同様
}

// --- 表示更新 ---
function refreshView() {
    const filteredTasks = applyFilter(allTasks, filterAndSortState);
    const sortedTasks = applySort(filteredTasks, filterAndSortState);
    view.renderTasks(sortedTasks);
    view.renderCounters(allTasks);
}

function applyFilter(tasks, state) { /* ... */ }
function applySort(tasks, state) { /* ... */ }

```